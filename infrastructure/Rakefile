#!/usr/bin/env rake
require 'nokogiri'
require 'json'
require 'rubygems'
require 'chef'
require 'rbconfig'

# Load common, useful tasks from Chef.
TOPDIR = File.expand_path(File.join(File.dirname(__FILE__), ".."))
load 'chef/tasks/chef_repo.rake'

STDOUT.sync = true

###########
#  Tasks  #
###########

desc "Launch new Windows EC2 instances to run integration tests"
task :integration_test_windows do
	stack_name = "Windows2008R2SpotInstance-test-#{Time.new.strftime("%Y%m%dT%H%M%S")}"
	template = "./templates/Windows2008R2SpotInstance.template"

	launch_stack(stack_name, template)
end

desc "Launch new Ubuntu EC2 instances to run integration tests"
task :integration_test_ubuntu do
	stack_name = "Ubuntu1204SpotInstance-test-#{Time.new.strftime("%Y%m%dT%H%M%S")}"
	template = "templates/Ubuntu1204SpotInstance.template"

	launch_stack(stack_name, template)
end

desc "Initialise / update chef cookbooks as defined in ./Cheffile"
task :update_chef_repo do
	puts "Initializing chef repo using ./Cheffile"
	puts `librarian-chef update` 
	puts `librarian-chef show` 
end

task :default => 'integration_test_ubuntu'

###########
# Helpers #
###########

def launch_stack(stack_name, template)
	puts "[WARNING] This takes about 30 min to run, and will start & stop real EC2 instances"

	puts "Validating template: #{template}"
	puts exec_python "scripts/validate-template.py #{template}"

	puts "Launching Ubuntu cloud stack in eu-west-1 region named #{stack_name}"
	puts exec_python "scripts/create-stacks.py #{stack_name} #{template} -p KeyName=labs-commander -p NotificationTopic=arn:aws:sns:{REGION}:{ACCOUNT}:as-labs-cityindex-com -p ChefConfigBucketName=cityindex.labs.chef_bootstrap -p ChefEnvironment=ec2-clock-accuracy-research_test -r eu-west --enable_iam"

	wait_for_stack(stack_name)

	puts "Deleting stack #{stack_name}"
	puts exec_python "scripts/delete-stacks.py #{stack_name} -r eu-west"
end

def exec_python(cmd) 
	is_windows = (RbConfig::CONFIG['host_os'] =~ /mswin|mingw|cygwin/)
	if is_windows then 
		cmd = "python #{cmd}" 
	else 
		cmd = "./#{cmd}"
	end
	out = `#{cmd}`
	fail(out) if $?.to_i != 0
	out
end

def wait_for_stack(stack_name)
	print "Waiting for stack to initialise .."
	stack_status = "CREATE_IN_PROGRESS"
	stack_status_reason = ""
	result = ""
	begin
		while stack_status == "CREATE_IN_PROGRESS"
			print "."; sleep 15; print "."; sleep 15; print "."; sleep 15; print "."; sleep 15 # 4 . over 60 sec

			result = exec_python "scripts/describe-stacks.py -r eu-west-1 -s #{stack_name} --xml"
			stacks =  Nokogiri::XML(result)
			stack_status = stacks.xpath('//StackStatus').text
		end

		stack_status_reason = stacks.xpath('//StackStatusReason').text	
		stack_init_log = JSON.parse(stacks.xpath('//OutputValue').text)

		puts "\n=========================================="
		puts "cfn-init.log for #{stack_init_log.keys[0]}"
		puts "=========================================="
		puts exec_python "scripts/decode-logs.py #{stack_init_log.values[0]}"
	rescue
		puts result
	ensure
		if (stack_status != "CREATE_COMPLETE") then
			fail("Stack creation failed: #{stack_status} - #{stack_status_reason}") 
		else
			puts stack_status
			puts "Stack created successfully"
		end
	end
end